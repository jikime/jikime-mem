// Prisma Schema for jikime-mem
// SQLite database per project

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 세션 정보
model Session {
  id            String         @id @default(cuid())
  sessionId     String         @unique @map("session_id")
  projectPath   String         @map("project_path")
  startedAt     DateTime       @default(now()) @map("started_at")
  endedAt       DateTime?      @map("ended_at")
  status        String         @default("active") // active, completed, error
  metadata      String?        // JSON string for additional data

  prompts       Prompt[]
  observations  Observation[]

  @@map("sessions")
}

// 사용자 프롬프트
model Prompt {
  id          String    @id @default(cuid())
  sessionId   String    @map("session_id")
  content     String
  timestamp   DateTime  @default(now())
  metadata    String?   // JSON string

  session     Session   @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)

  @@index([sessionId])
  @@index([timestamp])
  @@map("prompts")
}

// 도구 사용 관찰 (PostToolUse)
model Observation {
  id            String    @id @default(cuid())
  sessionId     String    @map("session_id")
  toolName      String    @map("tool_name")
  toolInput     String    @map("tool_input")   // JSON string
  toolResponse  String    @map("tool_response") // JSON string (truncated if too long)
  timestamp     DateTime  @default(now())
  duration      Int?      // milliseconds
  status        String    @default("success") // success, error
  metadata      String?   // JSON string

  session       Session   @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)

  @@index([sessionId])
  @@index([toolName])
  @@index([timestamp])
  @@map("observations")
}

// 컨텍스트 요약 (압축된 세션 정보)
model ContextSummary {
  id          String    @id @default(cuid())
  sessionId   String    @map("session_id")
  summary     String    // 압축된 컨텍스트 요약
  tokens      Int?      // 토큰 수
  createdAt   DateTime  @default(now()) @map("created_at")

  @@unique([sessionId])
  @@map("context_summaries")
}

// 설정
model Setting {
  id        String    @id @default(cuid())
  key       String    @unique
  value     String
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@map("settings")
}
